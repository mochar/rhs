:PROPERTIES:
:header-args: :async yes :session rhs-compare
:END:

* Preamble
#+begin_src jupyter-python
%load_ext autoreload
%autoreload 2

from glob import glob
from pathlib import Path
import os
os.chdir('/home/mochar/dev/rhs/analysis')

import jax
from jax import numpy as jnp
from jax import random
import matplotlib.pyplot as plt
import numpy as np
import numpyro
from numpyro.distributions import *
from numpyro.infer import Predictive
import dill
import seaborn as sns
import pandas as pd

import rhs
from experiments import Experiment

jax.config.update('jax_platform_name', 'cpu')
#+end_src

#+RESULTS:
asdas

* MCMC
** Load
#+begin_src jupyter-python
experiment = Experiment.mcmc_experiments['mcmc_reparam']
mcmc_trainers = {}
mcmc_runs = []
for path in glob(f'output/{experiment.name}/*/*'):
    path = Path(path)
    if path.stem == 'dataset': continue
    _, seed, reparam = path.stem.split('--')
    name = '/'.join(path.parts[-2:])
    trainer = rhs.TrainerMCMC.load(path)
    mcmc_runs.append({'name': name,
                      'dataset': path.parent.stem,
                      'seed': int(seed),
                      'reparam': reparam,
                      'divergences': int(trainer.diverging.sum())})
    mcmc_trainers[name] = trainer
mcmc_runs = pd.DataFrame(mcmc_runs)
mcmc_runs.index = mcmc_runs['name']

# mcmc_trainers = {Path(path).stem.lstrip('mcmc--'): rhs.TrainerSVI.load(path)
#                 for path in glob('output/mcmc--*.pkl')}
# mcmc_runs = pd.DataFrame(
#     [{'name': name, 'seed': int((parts:=name.split('--'))[0]), 'reparam': (parts:=parts[1].split('-'))[0], 'structure': parts[1], 'divergences': int(trainer.diverging.sum())} for name, trainer in mcmc_trainers.items()])
print(mcmc_runs)
#+end_src

#+RESULTS:
#+begin_example
                                                                                name  \
name                                                                                   
correlated/mcmc--17--ig:cen_ig:dec.pkl        correlated/mcmc--17--ig:cen_ig:dec.pkl   
correlated/mcmc--0--ii:dec2_ii:cen.pkl        correlated/mcmc--0--ii:dec2_ii:cen.pkl   
correlated/mcmc--11--ig:cen_ig:dec.pkl        correlated/mcmc--11--ig:cen_ig:dec.pkl   
correlated/mcmc--1--ii:dec_ii:dec.pkl          correlated/mcmc--1--ii:dec_ii:dec.pkl   
correlated/mcmc--11--ii:dec_ii:dec2.pkl      correlated/mcmc--11--ii:dec_ii:dec2.pkl   
...                                                                              ...   
uncorrelated/mcmc--15--ii:dec2_ii:cen.pkl  uncorrelated/mcmc--15--ii:dec2_ii:cen.pkl   
uncorrelated/mcmc--8--ii:dec2_ii:cen.pkl    uncorrelated/mcmc--8--ii:dec2_ii:cen.pkl   
uncorrelated/mcmc--14--ig:dec_ig:cen.pkl    uncorrelated/mcmc--14--ig:dec_ig:cen.pkl   
uncorrelated/mcmc--19--ig:cen_ig:dec.pkl    uncorrelated/mcmc--19--ig:cen_ig:dec.pkl   
uncorrelated/mcmc--13--ii:dec_ii:dec2.pkl  uncorrelated/mcmc--13--ii:dec_ii:dec2.pkl   

                                                dataset  seed         reparam  \
name                                                                            
correlated/mcmc--17--ig:cen_ig:dec.pkl       correlated    17   ig:cen_ig:dec   
correlated/mcmc--0--ii:dec2_ii:cen.pkl       correlated     0  ii:dec2_ii:cen   
correlated/mcmc--11--ig:cen_ig:dec.pkl       correlated    11   ig:cen_ig:dec   
correlated/mcmc--1--ii:dec_ii:dec.pkl        correlated     1   ii:dec_ii:dec   
correlated/mcmc--11--ii:dec_ii:dec2.pkl      correlated    11  ii:dec_ii:dec2   
...                                                 ...   ...             ...   
uncorrelated/mcmc--15--ii:dec2_ii:cen.pkl  uncorrelated    15  ii:dec2_ii:cen   
uncorrelated/mcmc--8--ii:dec2_ii:cen.pkl   uncorrelated     8  ii:dec2_ii:cen   
uncorrelated/mcmc--14--ig:dec_ig:cen.pkl   uncorrelated    14   ig:dec_ig:cen   
uncorrelated/mcmc--19--ig:cen_ig:dec.pkl   uncorrelated    19   ig:cen_ig:dec   
uncorrelated/mcmc--13--ii:dec_ii:dec2.pkl  uncorrelated    13  ii:dec_ii:dec2   

                                           divergences  
name                                                    
correlated/mcmc--17--ig:cen_ig:dec.pkl               7  
correlated/mcmc--0--ii:dec2_ii:cen.pkl               7  
correlated/mcmc--11--ig:cen_ig:dec.pkl              19  
correlated/mcmc--1--ii:dec_ii:dec.pkl                5  
correlated/mcmc--11--ii:dec_ii:dec2.pkl              6  
...                                                ...  
uncorrelated/mcmc--15--ii:dec2_ii:cen.pkl            8  
uncorrelated/mcmc--8--ii:dec2_ii:cen.pkl             3  
uncorrelated/mcmc--14--ig:dec_ig:cen.pkl             0  
uncorrelated/mcmc--19--ig:cen_ig:dec.pkl             5  
uncorrelated/mcmc--13--ii:dec_ii:dec2.pkl           12  

[280 rows x 5 columns]
#+end_example

** Divergences
#+begin_src jupyter-python
fig, axs = plt.subplots(figsize=(8, 6), ncols=2, layout='tight')
for ax, dataset in zip(axs, experiment.datasets):
    data = mcmc_runs[mcmc_runs['dataset'] == dataset]
    sns.stripplot(data=data, y='reparam', x='divergences', ax=ax)
    sns.boxplot(data=data, y='reparam', x='divergences', ax=ax)
    ax.set(title=dataset)
None
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/3761a4343d48f4920f77fad2bed6e407af27400d.png]]

** Coefficients
#+begin_src jupyter-python
for name, run in mcmc_runs.query('dataset == "correlated" & seed == 0').iterrows():
    tau_reparam, lambda_reparam = run['reparam'].split('_')
    fig, axs = plt.subplots(nrows=2, ncols=2, sharex='col', figsize=(10,4))
    for i, dataset in enumerate(experiment.datasets):
        divergences = []
        for seed in experiment.seeds:
            ds_name = name.replace('correlated/', f'{dataset}/').replace('mcmc--0', f'mcmc--{seed}')
            trainer = mcmc_trainers[ds_name]
            experiment.datasets[dataset].plot_coeffs(trainer, annotate=seed==0, axs=axs[:, i])
            divergences.append(int(mcmc_runs.loc[ds_name, 'divergences']))
        axs[0, i].set(title=f'{dataset}\n (div {divergences})')
    fig.suptitle(f'Tau {tau_reparam}, Lamda {lambda_reparam}')
    # plt.close(fig)
None
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/787731403cc1c08e39d1b196b0904286a5442c75.png]]
[[file:./.ob-jupyter/1131845bd47ae2e5243413212af77665c228aacc.png]]
[[file:./.ob-jupyter/3107d650803800797160df6ddf5e37fbf3595754.png]]
[[file:./.ob-jupyter/8d95bb49dc54d0ff1c5fe80e71526bde56f23b85.png]]
[[file:./.ob-jupyter/2acc17abd145c5cb23cbb0b948b88379b2dabf36.png]]
[[file:./.ob-jupyter/5799c7e0d8386c1d6b18a255fc871b83aaf67b48.png]]
[[file:./.ob-jupyter/0cc859c253c7f4dbd314b1c1d37c23c7c96fb81b.png]]
:END:

** Samples
#+begin_src jupyter-python
sites = ['lambda_aux1_dec', 'lambda_aux1', 'lambda_aux2_dec', 'lambda_aux2', 'lambda', 'coef']
for name, trainer in mcmc_trainers.items():
    fig, axs = plt.subplots(ncols=len(sites), figsize=(17,6), sharey=True)
    fig.suptitle(name)

    diverging = trainer.mcmc._states['diverging'][0]

    for site, ax in zip(sites, axs):
        ax.set(title=site)
        if site not in trainer.samples:
            continue
        samples = trainer.samples[site]
        
        x = pd.DataFrame(samples).melt()
        sns.violinplot(data=x, y='variable', x='value', orient='h', alpha=.5, ax=ax, zorder=100)
        sns.stripplot(data=x, y='variable', x='value', orient='h', alpha=.5, ax=ax, zorder=-10)

        # x = pd.DataFrame(samples[diverging]).melt()
        # sns.stripplot(data=x, y='variable', x='value', orient='h', c='r', ax=ax, zorder=100)
        
        ax.axvline(0, c='k', alpha=.5, ls='--')
        if site == 'coef':
            ax.axhspan(-.5, dataset.D_per-.5, alpha=0.1, color='k')
            ax.axhspan(dataset.D-dataset.D_per-.5, dataset.D-.5, alpha=0.1, color='k')
            for i in range(3):
                ax.plot([dataset.B_k_std]*2, [dataset.D_per*i, dataset.D_per*(i+1)], c='r')
None
#+end_src

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/5a85913d5c30ddabb5482531a139ac68b17aa910.png]]
[[file:./.ob-jupyter/29c617399364d776afcd7d6968d9f51dc9b559c1.png]]
[[file:./.ob-jupyter/cb88d0ef498c81e07f38390b52eb7867aedc2ddb.png]]
[[file:./.ob-jupyter/b0b15d8ad9caee78a3aac6e5ad56a4e4b9826ef6.png]]
[[file:./.ob-jupyter/ce2204ff3320e421db982afa75411f14104facf0.png]]
[[file:./.ob-jupyter/3bad5f2aba2b1a56a1d54d19e64838161cf5257b.png]]
[[file:./.ob-jupyter/883386f476f360ea1db1aebabfaaa13a580cc198.png]]
:END:

** Half-cauchy divergences
+ Less divergences with half-cauchy reparameterizations
  - Divergent samples are in the tails of half-cauchy?
+ Divergences in both ends when not reparameterized nicely
  - Mainly =base= and =ii_cen=
+ Divergens mostly when $\tau$ and/or $\lambda$ ~ 0

#+begin_src jupyter-python
sites = ['tau_aux1_dec', 'tau_aux1', 'tau_aux2_dec', 'tau_aux2', 'tau', 'lambda_aux1_dec', 'lambda_aux1', 'lambda_aux2_dec', 'lambda_aux2', 'lambda']
fig, axs = plt.subplots(nrows=len(mcmc_trainers), ncols=len(sites),
                        figsize=(2*len(sites), 2*len(mcmc_trainers)))
for i, (name, trainer) in enumerate(mcmc_trainers.items()):
    samples = trainer.samples
    for j, site in enumerate(sites):
        ax = axs[i, j]

        if i == 0:
            ax.set(title=site)
        if j == (len(sites)-1):#0:
            ax.set(ylabel=f'{name} (div={trainer.diverging.sum()})')
            ax.yaxis.set_label_position("right")
        if site not in samples:
            ax.axis('off')
            continue

        ax.hist(samples[site].flatten(), bins=30)
        sns.rugplot(samples[site][trainer.diverging].flatten(), height=1, c='red',
                    alpha=.5, ax=ax)
        ax.set_yticks([], [])

None    
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/00d5b6cc8efe9c36fc58a7009d58330d279d58a3.png]]


** Feature-level samples
#+header: :var trainer="ig_dec" x_site="coef_dec" y_site="lambda_reg"
#+header: :var trainer="base" x_site="coef" y_site="lambda_reg"
#+begin_src jupyter-python
trainer = mcmc_trainers[trainer]
diverging = trainer.mcmc._states['diverging'][0]
print('Diverging:', diverging.sum())

for j in range(dataset.D_per):
    fig, axs = plt.subplots(ncols=dataset.K, figsize=(10,3))
    fig.suptitle('Signal' if j == 0 else 'Noise')
    for i in range(dataset.K):
        d = i*dataset.D_per + j
        samples = {**trainer.samples}
        # samples.update(Predictive(trainer.conf.model, posterior_samples=trainer.samples, exclude_deterministic=False)(random.key(0)))
        x = samples[x_site][:, d]
        y = samples[y_site][:, d]
        sub = (x < np.quantile(x, .9)) & (y < np.quantile(y, .9))
        x = x[sub]
        y = y[sub]

        ax = axs[i]
        sns.kdeplot(x=x, y=y, zorder=-10, ax=ax, alpha=.5)
        ax.scatter(x, y, alpha=.3)
        ax.scatter(x[diverging[sub]], y[diverging[sub]], c='r', alpha=.7)
        
        ax.set(title=f'k={i}', xlabel=x_site, ylabel=y_site)
None
#+end_src

#+RESULTS:
:RESULTS:
: Diverging: 85
[[file:./.ob-jupyter/01e6b23088db96f8d28efb3ab81f935008633f8c.png]]
[[file:./.ob-jupyter/ff133be1168808fc6f51706e84f155c8a5d562d2.png]]
[[file:./.ob-jupyter/deb0a5c1bdbf4050bace39d8d6f9e35da8969e5b.png]]
[[file:./.ob-jupyter/d1ba816a09c8bb1291d809aea573ee6365a82518.png]]
[[file:./.ob-jupyter/502beeceb6c407c008aa625928c5f243c468c992.png]]
[[file:./.ob-jupyter/16475bdd7388e16baca383c5a2361f7553ddb60b.png]]
[[file:./.ob-jupyter/3c1ddc34f4c81dce65dc09af57c9e1d34064aee6.png]]
[[file:./.ob-jupyter/106a2b536a72227ff81a8d7a114f92c52dcc3793.png]]
[[file:./.ob-jupyter/00741e9742714199c5d85473a9645016e13e396b.png]]
[[file:./.ob-jupyter/9b7f06a2164d9a2221d2474f47f5b14e4dbe3a5c.png]]
:END:
** Univariate samples
#+begin_src jupyter-python
sites = ['noise', 'c2_aux', 'c', 'tau_aux1_dec', 'tau_aux1', 'tau_aux2_dec', 'tau_aux2', 'tau']
fig, axs = plt.subplots(nrows=len(mcmc_trainers), ncols=len(sites),
                        figsize=(2*len(sites), 2*len(mcmc_trainers)))
for i, (name, trainer) in enumerate(mcmc_trainers.items()):
    samples = trainer.samples
    for j, site in enumerate(sites):
        ax = axs[i, j]

        if i == 0:
            ax.set(title=site)
        if j == 0:
            ax.set(ylabel=f'{name} (div={trainer.diverging.sum()})')
        if site not in samples:
            ax.axis('off')
            continue

        ax.hist(samples[site], bins=30)
        sns.rugplot(samples[site][trainer.diverging], height=1, c='red',
                    alpha=.5, ax=ax)
        ax.set_yticks([], [])

None    
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/eaeacbde20fac19624c9c256034633507958ec74.png]]

* SVI
** Load
#+begin_src jupyter-python
experiment = Experiment.svi_experiments['svi_elbo']
experiment = Experiment.svi_experiments['svi_elbo_smol']
svi_trainers = {}
svi_runs = []
for path in glob(f'output/{experiment.name}/*/*'):
    path = Path(path)
    if path.stem == 'dataset': continue
    _, seed, reparam, structure, elbo = path.stem.split('--')
    name = '/'.join(path.parts[-2:])
    trainer = rhs.TrainerSVI.load(path)
    svi_runs.append({'name': name,
                      'dataset': path.parent.stem,
                      'seed': int(seed),
                      'reparam': reparam,
                      'structure': structure,
                      'elbo': elbo,
                      'loss': float(trainer.losses[-1])})
    svi_trainers[name] = trainer
svi_runs = pd.DataFrame(svi_runs)
svi_runs.index = svi_runs['name']
jax.config.update('jax_platform_name', 'cpu')
print(svi_runs.shape)
#+end_src

#+RESULTS:
: (480, 7)

** Loss
#+begin_src jupyter-python
fig, axs = plt.subplots(figsize=(8, 6), ncols=len(experiment.datasets), layout='tight',
                        sharey=True)
for ax, dataset in zip(axs, experiment.datasets):
    data = svi_runs[svi_runs['dataset'] == dataset]
    hue = 'elbo'
    hue = 'reparam'
    sns.stripplot(data=data, y='structure', x='loss', hue=hue, dodge=True, ax=ax)
    sns.boxplot(data=data, y='structure', x='loss', hue=hue, dodge=True, ax=ax, legend=False)
    ax.set(title=dataset)
    None
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/9c8d5c3fddc2f60cfeb7d06199a14df9aadd57c7.png]]

** Loss
#+begin_src jupyter-python
for name, run in svi_runs.iterrows():
    trainer = svi_trainers[name]
    if run['dataset'] == 'uncorrelated': continue
    plt.plot(trainer.losses, label=name)
# plt.legend()
plt.xlim([0, 400])
# plt.ylim([None, 200])
None
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/5381abe594095c9880f1da6928ee9763c9929625.png]]
** Coefficients
#+begin_src jupyter-python
coefs = pd.DataFrame([
    {'name': name, 'feature': str(k),
     'group': str(k // experiment.datasets[run['dataset']].D_per),
     'coef': float(svi_trainers[name].estimates['coef'][k])}
    for name, run in svi_runs.iterrows()
    for k in range(svi_trainers[name].conf.D)])
coefs.index = coefs['name']
coefs = pd.concat([coefs, svi_runs.loc[coefs['name'].values]], axis=1)

for i, dataset in enumerate(experiment.datasets):
    for j, structure in enumerate(experiment.structures):
        for k, elbo in enumerate(experiment.elbos):
            for l, reparam in enumerate(experiment.reparams):
                sub = coefs['dataset'] == dataset
                sub &= coefs['structure'] == structure
                sub &= coefs['elbo'] == elbo
                sub &= coefs['reparam'] == reparam
                if sub.sum() > 0:
                    fig, ax = plt.subplots(figsize=(15,3))
                    fig.suptitle(f'{dataset} - {structure} - {elbo} - {reparam}')
                    sns.stripplot(data=coefs[sub], x='seed', y='coef', hue='group', dodge=True, legend=False)
    
None
#+end_src

#+RESULTS:
:RESULTS:
: /tmp/ipykernel_2447618/2715018967.py:19: RuntimeWarning: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`). Consider using `matplotlib.pyplot.close()`.
:   fig, ax = plt.subplots(figsize=(15,3))
[[file:./.ob-jupyter/927a8a518eacca887272152839a9c57e6db25200.png]]
[[file:./.ob-jupyter/5e9877405bc5613b76ec5c5e9618572c3e9002bb.png]]
[[file:./.ob-jupyter/db37eebad4238bb9194d67d0f25158b47ff47a43.png]]
[[file:./.ob-jupyter/354ba4f58b260006b7cd2b61e8e6081dbafcde38.png]]
[[file:./.ob-jupyter/834b6b9d842439d742567808d09e5d9e1f8c2bc2.png]]
[[file:./.ob-jupyter/d0ded56e4695cb9a27de590613e1f2f2af59d6fb.png]]
[[file:./.ob-jupyter/9de044d9b550f32369e0a2448bd60c3fe2d80349.png]]
[[file:./.ob-jupyter/bc0aa651f07d78ef26fab63b9f99d39133762fcb.png]]
[[file:./.ob-jupyter/b425d08e95ff67901eab83ef988252ade71d4e6f.png]]
[[file:./.ob-jupyter/337497ae2bbb73d7e75e63ff937bcf2d84391565.png]]
[[file:./.ob-jupyter/5f8354bfe122463376233711155d1f69225a66e6.png]]
[[file:./.ob-jupyter/aa09a633883ac3297a3906ffd300347772fe9ac5.png]]
[[file:./.ob-jupyter/43cb0c44208ed4fc93f30e1b8b9eeb8ef5a996ce.png]]
[[file:./.ob-jupyter/12e51aa41537e9b08fa0128da8d3bd5f159ecf6e.png]]
[[file:./.ob-jupyter/58b65f44772feaea875db67a6b311a6bced72fe5.png]]
[[file:./.ob-jupyter/9aa6ec3fb3e02ff939b3d4fb83c2cf6b2e6fb39b.png]]
[[file:./.ob-jupyter/951d1ebcc49a22ff13d0d89c30425a292455b101.png]]
[[file:./.ob-jupyter/504e6b3ab2fe965d757962a1ed8d8427452858fc.png]]
[[file:./.ob-jupyter/55c2f14d466833e1a917fbdbd4b77c9ff78a4d6d.png]]
[[file:./.ob-jupyter/5849e3af414789811c990d4bcdd3959953f34f52.png]]
[[file:./.ob-jupyter/d4311d9b2e6447ed4089728e73bdf3891dfd55a7.png]]
[[file:./.ob-jupyter/e5f82859c9494105f9687132189d180e9e8ab7ee.png]]
[[file:./.ob-jupyter/e20a6bfa81ebb9ac50a347dcbf8f908d2cfe3843.png]]
[[file:./.ob-jupyter/cd0cb90929d8b0959352007a78f27443699ca73f.png]]
[[file:./.ob-jupyter/c2543f357a4c605701d5459d777ea7aeac855a12.png]]
[[file:./.ob-jupyter/0872986ab2767bdeb57bfa2943955c41defa21c1.png]]
[[file:./.ob-jupyter/22a192c4972116c82cd5760ee2993af77a4b8602.png]]
[[file:./.ob-jupyter/a306c83589ed5e1cc19096483c764ef853be6543.png]]
[[file:./.ob-jupyter/b315d896ec4012734fe311816ec7e0497f2fd0d8.png]]
[[file:./.ob-jupyter/1cd0272e4b03b3301c1782da1d246c8f959a0332.png]]
[[file:./.ob-jupyter/6e934675649d96626d398c0c7c81b0488cda75f4.png]]
[[file:./.ob-jupyter/8069ceb4c54e1797300717cdee1526aed1a5b0da.png]]
[[file:./.ob-jupyter/58c537415a7c50e7f6578352b10797cca24ed78f.png]]
[[file:./.ob-jupyter/7c5ca3e924447aa128a49e4b7c1c4cdd1e83e821.png]]
[[file:./.ob-jupyter/e8abb2cdd6115fb0e96cbd539c643470fe3dab92.png]]
[[file:./.ob-jupyter/dd56f155a93a673c9642e05a3848c024c257de20.png]]
[[file:./.ob-jupyter/c6c4afe33bc11f45fe91fd38cd8166795fe0f87a.png]]
[[file:./.ob-jupyter/1c703c28cdce0ab363ce30fa3fcfaed66bcb93c4.png]]
[[file:./.ob-jupyter/dc9cf17bb9552fb99f5172040410f3c14c71247c.png]]
[[file:./.ob-jupyter/38fb8f9148353c0391a1ad7f77a643b924869680.png]]
[[file:./.ob-jupyter/f9a4b4e7cdee10f32495d74888de8390d0398ba7.png]]
[[file:./.ob-jupyter/f185436eb0276db1f622a3d8da1da6b5675dc49b.png]]
[[file:./.ob-jupyter/0e41524a3a426b086d141d67a603d9985d887655.png]]
[[file:./.ob-jupyter/de0fc348c7539a04c99a0f16b4c5d3f7dcfeff68.png]]
[[file:./.ob-jupyter/c48b69a97a7a3bd1df46420513e81181e701c526.png]]
[[file:./.ob-jupyter/6d7b97d6a25503c0212328d603dc8bbb144c1369.png]]
[[file:./.ob-jupyter/96db1541567afdabea63da354a6a5bced7a5bdb5.png]]
[[file:./.ob-jupyter/a3c694efad3dabfddd9826fb5c48a928b7668630.png]]
:END:
** Coefficients
#+begin_src jupyter-python
for name, run in svi_runs.iterrows():
    trainer = svi_trainers[name]
    experiment.datasets[run['dataset']].plot_coeffs(trainer)
    plt.gcf().suptitle(name)
None    
#+end_src

#+RESULTS:
:RESULTS:
: /home/mochar/dev/rhs/rhs/datasets.py:130: RuntimeWarning:
: 
: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`). Consider using `matplotlib.pyplot.close()`.
: 
[[file:./.ob-jupyter/2e8d65f907569c691508bfc4c94cf539475b18a7.png]]
[[file:./.ob-jupyter/9ba39cc31b2c562d64bb0feb4f7dfcb72e5b2703.png]]
[[file:./.ob-jupyter/a825afc1cc869fb48f5dbc1fd6fe94b72b394357.png]]
[[file:./.ob-jupyter/93264402d17a0a2fea46e0035100207dae29e706.png]]
[[file:./.ob-jupyter/398224c23fa1341637b0939d0d3911476dbd47b0.png]]
[[file:./.ob-jupyter/0e8b4da9119004334cf963e38902f57c9e240213.png]]
[[file:./.ob-jupyter/12e4535c67043e6ed86513f64f9206578e733489.png]]
[[file:./.ob-jupyter/35acbc7658fd8a31e0885376de870d9d1d70f4a3.png]]
[[file:./.ob-jupyter/de7f1513e4366cc1a6aded81d135de222a7a432f.png]]
[[file:./.ob-jupyter/1b1cc100a76c9cd2a2b1b714d6ced5494a15da31.png]]
[[file:./.ob-jupyter/94e44aafc93c7329d535df17599f0e2cc6d328b5.png]]
[[file:./.ob-jupyter/03db36a34d0848dfa7bea49265f09369ab0a7d53.png]]
[[file:./.ob-jupyter/3160e4418a0bb5e9facf01a9a3a73448fe85b3f9.png]]
[[file:./.ob-jupyter/18ff60635e30a342ba6ad948490e99bf4f1074c3.png]]
[[file:./.ob-jupyter/310b73f6097f6ba2645e4a54f7f98e1c6a2ce7f8.png]]
[[file:./.ob-jupyter/be0f5f0f68927751a1b29881975444cfe5deb721.png]]
[[file:./.ob-jupyter/541dce23b20cb06f94bd2922753de681958cdcb4.png]]
[[file:./.ob-jupyter/67949c0dd791c12b5e04d79f36d0fe415b82fbb0.png]]
[[file:./.ob-jupyter/3dfc71bddb373118446081f9524dd6956f3b08e3.png]]
[[file:./.ob-jupyter/7f64f8499d2a5190581e555f3871ee8d78c6ff4c.png]]
[[file:./.ob-jupyter/86fe56879c588d416387859694cb8780ddc18231.png]]
[[file:./.ob-jupyter/a8ab95f5e43dd500b98deb9d5baa999327f756e6.png]]
[[file:./.ob-jupyter/d32d35edbd505a1862d634036f835ec1721a3573.png]]
[[file:./.ob-jupyter/9c50138ea94995efa698a5cde81f24ba66288f19.png]]
[[file:./.ob-jupyter/db3dc7504382d4488d8edb1048f03119fdf00737.png]]
[[file:./.ob-jupyter/c2004e542fc701e697fb68c02d6b8aa1873fd134.png]]
[[file:./.ob-jupyter/0bcfd57c5b1ececdc917735ad7dfb7cb960b6fad.png]]
[[file:./.ob-jupyter/634cbd2371c957c73842afc3a49dd6d56490a381.png]]
[[file:./.ob-jupyter/41bca06b8989b037f4e416240dbd0f637a0c6315.png]]
[[file:./.ob-jupyter/f86a2f56207a1a6e555678ac20c24f0ef1d06f20.png]]
[[file:./.ob-jupyter/ca9103df0a7257df3d2094a722af6cca04bc45ac.png]]
[[file:./.ob-jupyter/a6e1f95a2071eec9d9f4a66c531759c8465cbedb.png]]
[[file:./.ob-jupyter/f33b48494fd18e954883d9c4ab9e3092794b8f23.png]]
[[file:./.ob-jupyter/301b8e9a204e75d5719d7d030a9c0b3c353a9ee5.png]]
[[file:./.ob-jupyter/bf983768846865aa3defd234c2277cf1c1dd29dc.png]]
[[file:./.ob-jupyter/b77cd20dac12cd571430dcaa615bc226f693bf41.png]]
[[file:./.ob-jupyter/f9d6be77c8eb381c1959e5d4d91179a6900372b1.png]]
[[file:./.ob-jupyter/772768d0ca73314eea6876c2fd398785eeeb8eaa.png]]
[[file:./.ob-jupyter/3e8fe64c49454baa437f3465a31ce434bc65b5b5.png]]
[[file:./.ob-jupyter/743336d652f5c39ac880d76a76f008950067057d.png]]
[[file:./.ob-jupyter/9b2ff4f55b1734b75b59a1acb28fe531aaf5f993.png]]
[[file:./.ob-jupyter/c416294d5686f602465231cf0e7116ee817fb4c9.png]]
[[file:./.ob-jupyter/132cb376363d0f2013b9fb0f1839dd97e4466a85.png]]
[[file:./.ob-jupyter/7960ac72365be9fedabd8b854899aae26578e2e7.png]]
[[file:./.ob-jupyter/08de7222fd2c081b7507a79b5f3c9c0ad28ff44e.png]]
[[file:./.ob-jupyter/7600fd60a15870e538a13792b081a2251f4298cc.png]]
[[file:./.ob-jupyter/4ffbfb30879be79b902b06ec0ae8265b3a013652.png]]
[[file:./.ob-jupyter/22ade123019da05d210f01905ebf9914c2e3c830.png]]
[[file:./.ob-jupyter/b12164127c0b4bf0269548502b90ccf9e4e7624d.png]]
[[file:./.ob-jupyter/89cf236ec233dc7b9780f77085c3c4e69cd11303.png]]
[[file:./.ob-jupyter/f022220c280d1d36438a44d12f9541ff071eb1bd.png]]
[[file:./.ob-jupyter/7105108c0ed8f4865d233b94207875625372c82e.png]]
[[file:./.ob-jupyter/a6a76a7e035ef658cef2c3593e87a6d39b28b9bd.png]]
[[file:./.ob-jupyter/64b5905ee247ef654ed0a2b27f17960e1432b83a.png]]
[[file:./.ob-jupyter/0534afaa198e2c86a571eeeb93a1efcac58994a5.png]]
[[file:./.ob-jupyter/4aab64ec1faf18b01a652071974306d009c5acc1.png]]
[[file:./.ob-jupyter/653e505142df3ad94a31862c71c7e0a3ec890a42.png]]
[[file:./.ob-jupyter/1e41ef877f516f518db53c2be6033c3385a66cb1.png]]
[[file:./.ob-jupyter/3275ed075247777e8d8678887ba1b3d0b3f82503.png]]
[[file:./.ob-jupyter/740a154086a12169f6741c45b199a58c6c89ac63.png]]
[[file:./.ob-jupyter/ec46fbe376d5a5dd4693fbffc3e430df5f31b16c.png]]
[[file:./.ob-jupyter/ad71396afebe050f2744023de461402fc3e0d8b2.png]]
[[file:./.ob-jupyter/5a21df6ff90ddea2326131dc933abd494ffb4b2d.png]]
[[file:./.ob-jupyter/36277fba026920ec940b15862459b24c136e7e30.png]]
[[file:./.ob-jupyter/6e7ecb2bd9c7a2db8f5ceabca797203a0b713f5a.png]]
[[file:./.ob-jupyter/649799e30b0e6409c659aeef9b383a6a65c852c7.png]]
[[file:./.ob-jupyter/3ce2853bbbad9dd2e1b6f60699662696df76945a.png]]
[[file:./.ob-jupyter/d2e8d2f8b8675f0eea58331f977c6071269bc7af.png]]
[[file:./.ob-jupyter/581b4ed08c4d14650b3d4c1bef31e70368dfb227.png]]
[[file:./.ob-jupyter/481f56badbfee64c030a23807e8d7c9b74a773a0.png]]
[[file:./.ob-jupyter/2870b81963cde0a3494dcaa4a357f9e7ef8f1422.png]]
[[file:./.ob-jupyter/7fa008cd07f97b4ac06566776a7f8ba5f6e4ce55.png]]
[[file:./.ob-jupyter/0389e618880a0e53d6780f0aeab98eec3dd1e21f.png]]
[[file:./.ob-jupyter/795c8f3cd05c6a8ec03299712115c3c61fd789e4.png]]
[[file:./.ob-jupyter/ed6226f94b5ed12ff2b9dbd4147e8e38fb04c053.png]]
[[file:./.ob-jupyter/9bddd9d117237981df3dbfacceed984c2fa47c45.png]]
[[file:./.ob-jupyter/5b6e81aea44b58b6f24baa708309f04789ab6f9c.png]]
[[file:./.ob-jupyter/70d95363013be61198e65bd2a9c2c3432b9124c1.png]]
[[file:./.ob-jupyter/2f815636e0398832bfe50feb62c0bb527796e720.png]]
[[file:./.ob-jupyter/e7ecd0d3d26ebcbb197818bea2eee7317e8ee653.png]]
[[file:./.ob-jupyter/be5545e82494b497ae7f8e5b35dff5fab178a2e5.png]]
[[file:./.ob-jupyter/1487dfb0c57178d4ad234bb97040d4b8d4eb295e.png]]
[[file:./.ob-jupyter/cf774b464d9262c044f5e8116c72e0c9a7485fd2.png]]
[[file:./.ob-jupyter/89438bb95136f5a518dd6cf3a0d5e6075d0aa29b.png]]
[[file:./.ob-jupyter/20cad9e57cf599c250a6d4a929c79d3c05e48679.png]]
[[file:./.ob-jupyter/a3349733440bcb9651e2e214bfa729f8df52bfb2.png]]
[[file:./.ob-jupyter/3d32a82b070d25ebbd48de645030c93bead715ff.png]]
[[file:./.ob-jupyter/4c679c9776a003772f511199e84f61f50049c408.png]]
[[file:./.ob-jupyter/8beb09167e5aed4de57a3c92f42f1dd1c0f56c26.png]]
[[file:./.ob-jupyter/5bd3035fac82b5f72913e8938b4f501d5f0ad58b.png]]
[[file:./.ob-jupyter/bcf083db8d47308ec733bf0abe37b08a1ddd2301.png]]
[[file:./.ob-jupyter/aff29ed2c2fd45bd64ebd4e00106dba796c0f3bc.png]]
[[file:./.ob-jupyter/15bb7bf9c1bbd8228545e4ef0f71754c91d75c53.png]]
[[file:./.ob-jupyter/95bd5983673f2a2764f031c1b07aab3f6597f8f1.png]]
[[file:./.ob-jupyter/4fd0c5d39d8d1849d76260aa3454b8aaa66a46ef.png]]
[[file:./.ob-jupyter/4b9f4ce886f34a1f7e47fef9e39316bd3094a25c.png]]
[[file:./.ob-jupyter/d322db791ae07c761c5ccbe78d23b31518ac5b39.png]]
[[file:./.ob-jupyter/3d44a63ab0dceee42abc55c9fd776252dd9ae9ce.png]]
[[file:./.ob-jupyter/fdda014aad9a2baacf891b582d428e488ce2d6a2.png]]
[[file:./.ob-jupyter/4df20ad96ed1b4060b4030933ef4561037400015.png]]
[[file:./.ob-jupyter/b067f481abe08b0ebbbe96169175eed734714bc5.png]]
[[file:./.ob-jupyter/aef6a99dcf49f6ef77945efff4c8b26f6152679c.png]]
[[file:./.ob-jupyter/b6f8b9566c0e48e9e037a7af6ffff8577f385a3d.png]]
[[file:./.ob-jupyter/769e6dcfa7fec0d8447d868245cf300cac9d1fef.png]]
[[file:./.ob-jupyter/669a4e8a583549f9abda9130363e661928d2efb1.png]]
[[file:./.ob-jupyter/e5355c45c08a9cf6978367b67c1605f1784e6b31.png]]
[[file:./.ob-jupyter/24004b9a931d3984517f7abf522a7739e210c293.png]]
[[file:./.ob-jupyter/a8b62d81ee2f49443d2f0d1d26d1848d2bc447d7.png]]
[[file:./.ob-jupyter/803e5b5de56b1371bb354e92faf41b805d5c080f.png]]
[[file:./.ob-jupyter/1c1ed524bbed145ded0c0f49c5b3cc1a0531c08d.png]]
[[file:./.ob-jupyter/876aaf36dc0f46765e1c01f03368135d8664c425.png]]
[[file:./.ob-jupyter/424c36518ef86bf392cb49f3130ea2f5f93b6373.png]]
[[file:./.ob-jupyter/7dd9aaa0d38d285266c95611cf152ff3a67eac19.png]]
[[file:./.ob-jupyter/215e2948b2cc38a28777dc56afce87231bf622b9.png]]
[[file:./.ob-jupyter/c0c5af404732418b72c3643776792810155014ce.png]]
[[file:./.ob-jupyter/0d83db1b9a7ffd66f736aeef8acd5656a6cd0480.png]]
[[file:./.ob-jupyter/56d24fdc801d21f690ce7d48e4871fc4d0a7390b.png]]
[[file:./.ob-jupyter/41d7c5788ba37a79f9be642522abda7153b929f4.png]]
[[file:./.ob-jupyter/08dd7e4876f8c17f5a4c8aae2723d4f1a42964f8.png]]
[[file:./.ob-jupyter/6fc7445d65a620c474a978ce129ea400c19cfcc9.png]]
:END:
** Sampling
#+begin_src jupyter-python
fig, axs = plt.subplots(
    nrows=len(svi_trainers), ncols=dataset.K, sharex=False,
    figsize=(3*dataset.K,2*len(svi_trainers)),
    gridspec_kw=dict(wspace=0.2, hspace=0.2))

for i, (name, trainer) in enumerate(svi_trainers.items()):
    for k in range(dataset.K):
        m = trainer.posterior('lambda').mode
        m = m[k*dataset.D_per:(k+1)*dataset.D_per]
        d = m.argmax() + k*dataset.D_per

        ax = axs[i, k]
        corr = trainer.params['corrs.lambda_coef'][d]
        ax.set(title=f'corr={corr:.3f}')
        samples = trainer.sample_posterior(method='trace')
        ax.scatter(samples['lambda'][:, d], samples['coef'][:, d], label='Trace')
        
        samples = trainer.sample_posterior(method='posterior')
        # ax.scatter(samples['lambda'][:, d], samples['coef'][:, d], label='Posterior')
        
        # plt.legend()
None        
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/044a26dc2961dee75744ce9c8a5eb7af22f323da.png]]
